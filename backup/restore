#!/usr/bin/env bash

## Restore from a backup
set -ex

assert_file_exists() {
    if !([ ! -z "$1" ] && [ -f "$1" ]); then
        echo "Backup dir $1 does not exist"
        echo "Usage: restore <backup_dir>"
        exit 1
    fi
}

assert_all_data_exists() {
    if !([ ! -z "$1" ] && [ -d "$1" ] && [ -f "$1/pgdata_backup.tar" ] && [ -f "$1/redis_backup.tar" ] &&
        [ -f "$1/prerun_backup.tar" ] && [ -f "$1/results_backup.tar" ] && [ -f "$1/uploads_backup.tar" ]); then
        echo "Backup dir $1 is incomplete"
        echo "Usage: restore <backup_dir>"
        exit 1
    fi
}

unzip() {
    tar -xvf $1 -C $2
}

restore() {
    docker exec hint_db psql -U postgres hint <$1/db_dump.sql
    docker run --rm --volumes-from hint_redis -v $1:/backup busybox tar -xvf /backup/redis_backup.tar /data
    docker run --rm --volumes-from hint_hintr -v $1:/backup busybox tar -xvf /backup/prerun_backup.tar /prerun
    docker run --rm --volumes-from hint_hintr -v $1:/backup busybox tar -xvf /backup/results_backup.tar /results
    docker run --rm --volumes-from hint_hintr -v $1:/backup busybox tar -xvf /backup/uploads_backup.tar /uploads
}

ABSOLUTE_PATH="$(
    cd "$(dirname "$1")"
    pwd
)/$(basename "$1")"
WORKING_DIR=$ABSOLUTE_PATH/working
assert_file_exists $1
unzip $1 $WORKING_DIR
assert_all_data_exists $WORKING_DIR
restore $WORKING_DIR
